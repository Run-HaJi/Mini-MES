# 🛠️ Mini-MES 开发日记 (2026-02-06) - Part 2

> **记录者**: Run-Haji
> **状态**: v0.6 Traceability (Data Query & Filtering)
> **关键词**: Dynamic SQL, Query Params, Docker Ports, Windows IME, Data Traceability

## 🔍 里程碑：数据的追溯与检索 (Traceability)

### 1. 核心成就 (Achievements)
在完成了 v0.5 的安全大门后，我们在 v0.6 重点解决了“数据不可查”的痛点。
现在，Mini-MES 不再只是一个显示最新 20 条数据的“流水账”，而是一个支持**多维度历史追溯**的查询台。这意味着系统正式具备了工业现场的“复盘能力”。

* **Backend**: 实现了动态 SQL 查询构建，支持按 `line_id` (产线) 和 `time_range` (时间段) 组合筛选。
* **Frontend**: 引入了日期范围选择器 (`el-date-picker`) 和下拉菜单，实现了直观的查询交互。

### 2. 技术细节 (Technical Implementation)

#### 🐍 后端改造 (FastAPI + SQLAlchemy)
* **文件**: `src/backend/app/api/production.py`
* **策略**: 保持了 v0.4 的 AES 解密逻辑和 Excel 导出功能不变，仅对 `/list` 接口进行了非破坏性升级。
* **逻辑**: 使用 `Optional` 类型接收查询参数。如果参数存在，则通过 `.where()` 方法动态拼接到 SQL 语句中，而非写死查询条件。

#### 🎨 前端升级 (Vue 3)
* **文件**: `src/frontend/src/views/DashboardView.vue`
* **组件**: 新增 `SearchToolbar` 区域，集成 Element Plus 的日期选择器。
* **交互**: 
    1.  用户点击查询时，前端提取 `lineId` 和 `dateRange`。
    2.  将 JS `Date` 对象转换为 Unix 时间戳（秒）。
    3.  拼接 URL Query String (`?line_id=...&start_time=...`) 发送请求。
    4.  复用现有的表格组件展示筛选结果。

### 3. 踩坑与排错 (Troubleshooting)

#### 💥 Docker 端口幽灵 (The Port Conflict)
* **现象**: 修改后端代码后尝试重启，报错 `Bind for 0.0.0.0:3306 failed: port is already allocated`。
* **原因**: 使用 `Ctrl+C` 停止 Docker Compose 时，部分容器（尤其是 MySQL）未完全退出，仍占用端口。直接 `docker-compose up` 会导致新旧容器冲突。
* **解决**: 必须严格执行 `docker-compose down` 彻底清理旧容器网络和进程，再执行构建。

#### ⌨️ 开发环境之痛 (Windows IME Issues)
* **现象**: Windows 11 输入法在 VS Code (Electron 应用) 中频繁自动切换中英文，导致开发体验极差（误触、全角符号报错）。
* **尝试**: 尝试了“高级键盘设置”、“禁用 Shift 切换”、“添加美式键盘”、“兼容性模式”等多种方案，效果均不理想。这是操作系统焦点管理与 IDE 框架之间的底层冲突。
* **决策**: **止损**。不为工具的缺陷浪费过多的开发精力。接受环境的不完美，依靠肌肉记忆（手动切换）规避干扰，将精力集中在代码逻辑本身。

---

## 📈 架构思考 (Reflections)

1.  **数据的价值在于流动**: 只有当数据能被检索、筛选和导出时，它才对工厂管理者产生价值。v0.6 是从“采集系统”向“决策支持系统”转型的第一步。
2.  **兼容性优先**: 在升级后端接口时，我们小心翼翼地保留了 AES 解密逻辑。在实际工程中，**“新功能不破坏旧业务”** 是铁律。

## 📅 下一步计划 (Next Steps)

* **v0.7 Dashboard Metrics**: 将查询到的数据进行聚合计算，在页面顶部展示“产量”、“良品率”等统计卡片，打造“驾驶舱”体验。
* **v1.0 Release Prep**: 准备发布正式版。