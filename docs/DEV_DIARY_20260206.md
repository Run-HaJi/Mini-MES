# 🛠️ Mini-MES 开发日记 (2026-02-06)

> **记录者**: Run-Haji
> **状态**: v0.5 Admin Dashboard (Authentication & Access Control)
> **关键词**: JWT, Vue Router Guard, CORS, Dependency Management, Minimalism

## 🛡️ 里程碑：给系统装上大门 (Authentication System)

### 1. 核心成就 (Achievements)
今天我们将 Mini-MES 从一个“裸奔”的数据展示页，升级为具备完整鉴权能力的后台管理系统。
* **后端 (Backend)**: 实现了基于 JWT (JSON Web Token) 的 Token 签发机制。
* **前端 (Frontend)**: 完成了登录页 (`Login.vue`)、路由守卫 (`Router Guard`)、Token 持久化存储及退出登录功能。
* **交互闭环**: 用户必须登录 -> 获取 Token -> 访问 Dashboard -> 自动带 Token 请求数据。

### 2. 踩坑与决策 (Troubleshooting & Decisions)

#### 💥 依赖地狱 (The Dependency Hell)
* **问题**: 试图引入银行级加密库 `passlib[bcrypt]` 和 `argon2` 时，导致后端在 Docker `python:3.10-slim` 环境下崩溃（报 `500` 或 `ERR_EMPTY_RESPONSE`）。
* **原因**: `slim` 镜像缺少 C 语言编译器 (`gcc`)，无法构建底层哈希库。
* **解决**: **保持克制，回归简单**。
    * 果断移除所有需要编译的第三方哈希库。
    * 使用 Python 原生标准库 `hashlib` (SHA256) 实现密码校验。
    * **哲理**: 在当前阶段，“能跑且稳定”优于“过度设计的安全性”。

#### 🚧 跨域拦截 (CORS Blocking)
* **问题**: 登录后请求 `/list` 接口失败，虽然 Token 已带上，但浏览器报 CORS 错误。
* **原因**: 后端 `CORSMiddleware` 未显式允许 `Authorization` 请求头。
* **解决**: 修改 `main.py`，设置 `allow_headers=["*"]`。

#### 🧩 数据格式兼容性
* **问题**: 前端代码死板地校验 `{code: 200}`，导致当后端直接返回数组时页面显示无数据。
* **解决**: 增强前端鲁棒性，同时兼容“标准响应结构”和“纯数组结构”。

---

## 🏗️ 架构变更 (Architecture Changes)

### Backend
* 新增 `api/auth.py`: 处理登录请求。
* 精简 `requirements.txt`: 移除 `bcrypt`, `passlib`，仅保留 `python-jose`。

### Frontend
* 新增 `Login.vue`: 工业风深色登录界面。
* 更新 `DashboardView.vue`: 增加顶部导航栏、用户信息及退出按钮。
* 配置 `vite.config.js`: 设置 `/api` 反向代理，解决开发环境跨域问题。

---

## 📅 下一步计划 (Next Steps)

v0.5 的基础鉴权已完成，接下来的重点是将“看板”升级为真正的“管理台”。

* **多维度查询 (Traceability)**: 实现按时间、产线、SKU 筛选历史记录。
* **统计看板**: 在首页顶部增加“今日产量”、“良品率”等聚合数据卡片。

> **总结**: 今天的胜利属于“实用主义”。代码是为了解决问题而生的，而不是为了堆砌库而生的。