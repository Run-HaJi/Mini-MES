# 🛠️ Mini-MES 开发日记 (2026-02-04)

> **记录者**: 核心开发组
> **状态**: v0.3 Business Release (Excel Reporting)
> **关键词**: Technical Audit, Event Loop, Request Scope, Hybrid Storage, Anti-Patterns

## 🛑 关键转折：从“黑盒焦虑”到“白盒审计” (The Turning Point)

### 1. 危机时刻 (The Crisis)
* **触发点**: 在昨日网络故障与今日早间复盘时，作为架构师，察觉到对底层机制（Async IO, Packaging, Network）的掌控感缺失。
* **决策**: **果断按下“暂停键”**。拒绝在基础不牢的情况下堆砌功能，启动深度技术复盘 (Technical Workshop)。

### 2. 深度复盘与认知重构 (Cognitive Refactoring)
下午的“白盒化拆解”不仅补齐了知识盲区，更建立了完整的底层认知体系：

* **后端架构机制 (FastAPI & Async IO)**:
    * 明确了 **Event Loop (事件循环)** 是协作式多任务的核心，理解 `async/await` 旨在让出 CPU 以处理 IO 密集型任务。
    * 掌握了 **Dependency Injection (依赖注入)** 的本质是 *Request Scope*（请求级）的工厂模式，完美解决了数据库连接生命周期的自动化管理。
    * 厘清了 Uvicorn (ASGI Server) 与 FastAPI (App) 的分层关系。

* **数据存储策略 (Hybrid Storage)**:
    * 确认了 **Relational + JSON Hybrid** 模式的可行性：利用 MySQL 8.0 原生 JSON 存储非结构化数据，兼顾了灵活性与未来通过虚拟列索引优化的可能性。
    * 理解了 SQLAlchemy 2.0 在异步环境下的范式 (`execute` + `scalars`) 及 `expire_on_commit=False` 的必要性。

* **边缘端交付原理 (System Packaging)**:
    * 去魅 `PyInstaller`：它执行的是 **Freezing (冻结)** 而非编译。`.exe` 实质是 Bootloader + Python解释器 + 字节码 + 依赖库的自解压包。
    * 理解了运行时解压至临时目录 (`_MEIxxxx`) 的机制，找到了冷启动延迟的根源。

### 3. 技术债审计 (Technical Debt Audit)
基于新认知，我们识别出了当前 v0.2 版本中潜伏的风险（计划在 v1.0 前修复）：
* **数据库风险**: 默认连接池配置 (`pool_size=5`) 且未设置 `pool_recycle`，生产环境可能面临高并发阻塞或 "MySQL Gone Away" 导致的断连。
* **反模式 (Anti-Patterns)**: 捕获异常后手动返回 JSON `{code: 500}` 但 HTTP 状态码维持 200，这会误导监控系统，需整改为标准的 `HTTPException` 抛出。
* **安全隐患**: CORS 配置 `allow_origins=["*"]` 过于宽泛，且 SQL `echo=True` 在生产环境存在日志泄露风险。

---

## 🏆 晚间战果：v0.3 商业化落地 (Night Shift Execution)

带着审计后的清醒头脑，晚上的开发势如破竹，迅速攻克了商业化报表功能。

### 1. Excel 报表导出 (Business Feature)
* **需求**: 将数据库中的生产记录清洗并导出为 `.xlsx` 报表。
* **实现**:
    * **Backend**: 引入 `pandas` 和 `openpyxl`。利用对 Hybrid Storage 的理解，精准地将 JSON Payload (`sku`, `weight`) 摊平为独立列。
    * **Protocol**: 使用 `StreamingResponse` + `BytesIO` 实现内存流式下载，避免了磁盘 IO 开销。
    * **Frontend**: 极速完成了 Vue 组件的事件绑定。

### 2. 工程化排坑 (Engineering)
* **Docker 镜像加速**: 在引入 `pandas` 大包导致构建超时时，冷静分析网络瓶颈，修改 `Dockerfile` 切换至清华镜像源 (`-i https://pypi.tuna.tsinghua.edu.cn/simple`)，一次性构建成功。

---

## 📝 总结 (Summary)

今天的**“慢”**，是为了未来的**“稳”**。
如果下午没有停下来进行那场“白盒审计”，我们可能还在错误的数据库连接池配置上裸奔，甚至在生产环境泄露 SQL 日志。
**这一天，我们从“代码搬运工”进化为了“系统架构师”。**

---

## 🔮 明日预告 (Next Step)

* **目标**: v0.4 Security Update (安全升级)
* **任务**: 攻克最后的技术堡垒——**AES 加密/解密**。
    * 边缘端 (Client): 模拟真实的加密数据发送。
    * 服务端 (Server): 实现对应的解密逻辑。
    * *这将是对“边缘端计算”能力的终极测试。*