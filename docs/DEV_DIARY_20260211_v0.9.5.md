# 🛠️Mini-MES 开发日记 v0.9.5 - 边缘视觉节点 (Edge Node) 核心能力落地

**日期**: 2026-02-11  
**作者**: Run-Haji 
**版本**: v0.9.5 (Visual Core Complete)  
**状态**: ✅ 已归档

---

## 🎯 里程碑目标
1.  **彻底解决 OCR 依赖问题**：废弃笨重的 PaddleOCR 原生库，迁移至轻量级 ONNX 架构。
2.  **实现真实视觉闭环**：打通 `摄像头 -> YOLO定位 -> 图像切片 -> OCR识别` 的全链路数据流。
3.  **验证系统鲁棒性**：通过对抗样本（手写涂改图片）证明系统具备真实的“视觉感知”能力，而非硬编码。

---

## 🛠️ 核心技术变更

### 1. OCR 引擎重构 (Engine Migration)
* **背景**：原计划使用的 `paddlepaddle` 框架因网络环境（VPN冲突）和依赖地狱（protobuf 版本冲突）导致无法在 Windows 本地环境部署。
* **决策**：切换至 **RapidOCR (ONNX Runtime版)**。
* **优势**：
    * **零依赖**：无需安装深度学习框架，仅依赖 `onnxruntime` 和 `opencv-python`。
    * **轻量化**：模型文件随包分发，无额外下载负担。
    * **标准化**：与 YOLO 模型统一使用 `.onnx` 格式，简化了推理管线。

### 2. 鲁棒性解析逻辑 (Robust Parsing Logic)
* **问题**：OCR 引擎返回的数据结构在不同版本间存在差异（扁平列表 vs 嵌套列表），导致 `ValueError: too many values to unpack` 崩溃。
* **解决方案**：在 `ocr_service.py` 中实现了**“万能解析器”**。
    * 引入类型检查 (`isinstance`) 和长度防御 (`len >= 2`)。
    * 实现了对碎片化字符（如 `['2025', '7', '66']`）的自动拼合逻辑。
    * 增加了 `float()` 强转防御，解决了置信度类型不匹配 (`str` vs `float`) 的 Bug。

### 3. 模型资产规范化 (Asset Standardization)
* **操作**：将默认的训练产物 `best.onnx` 重命名为 **`yolo_v8_n.onnx`**。
* **意义**：明确了模型版本（v8）和量级（Nano），符合工业软件的资产管理规范。

---

## 🧪 测试与验证 (Validation)

### 实验 A：对抗攻击测试 (Adversarial Attack)
* **输入**：手动涂改的 `target_sample.jpg`（将 `08` 涂改为手写 `99`）。
* **预期**：识别出非标准字符，证明系统未作弊。
* **结果**：
    * OCR 输出：`生产日期: 2025766/08`（成功识别到涂改痕迹，`99` 因连笔被识别为 `66`）。
    * **结论**：系统具备真实的像素级读取能力，非“硬编码”逻辑。

### 实验 B：标准样本测试 (Golden Sample)
* **输入**：标准的 `2025/08/08` 标签图像。
* **结果**：
    * YOLO 定位：`[-2, -1, 708, 78]` (精准覆盖文本行)。
    * OCR 识别：`生产日期: 2025/08/08`。
    * 耗时：~800ms (Python CPU 推理，属于正常范围)。
    * **结论**：**视觉识别核心链路已完全跑通。**

---

## 📚 技术沉淀：ONNX 生态体系
本次重构厘清了边缘计算节点的技术栈关系：
* **OpenCV**：负责图像预处理（ROI 切割、灰度化）。
* **YOLOv8**：负责目标检测（Where is the text?）。
* **RapidOCR**：负责文字识别（What is the text?）。
* **ONNX Runtime**：作为统一的推理后端（Inference Backend），消除了 PyTorch 和 PaddlePaddle 之间的框架壁垒，实现了“一次转换，到处运行”。

---

## 🚀 下一步计划 (v0.9.6)
1.  **数据清洗 (Sanitization)**：引入 `re` 正则表达式模块，将 OCR 读取的脏数据（如 `2025766/08`）清洗为标准的 `YYYY-MM-DD` 格式。
2.  **业务逻辑集成**：将识别到的 `batch_date` 真正写入到 `production_data` 字典中，不再返回 `Unknown`。
3.  **API 联调**：准备对接后端 `FastAPI` 接口，上传真实的现场数据。

---

> **架构师备注**：
> "今天的报错虽然多，但每一个报错都把我们推向了更正确的架构。从 Paddle 到 ONNX 的转变，不仅是为了修 Bug，更是为了未来的跨平台部署打基础。Mini-MES 终于长出了真正的‘眼睛’。"